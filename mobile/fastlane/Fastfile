default_platform(:ios)

desc "Complete release workflow for both iOS and Android"
desc "Assumes version and CHANGELOG.md have already been updated by Claude"
desc "This will:"
desc "  1. Build and upload iOS to App Store"
desc "  2. Build Android AAB and open folder for Google Play upload"
lane :release_all do
  # Get current version for display
  pubspec_path = "../pubspec.yaml"
  pubspec = File.read(pubspec_path)
  version_line = pubspec.match(/version:\s*(\d+\.\d+\.\d+\+\d+)/)

  if version_line
    UI.message("üì¶ Building version: #{version_line[1]}")
  end

  # Build and upload iOS (without version bump)
  UI.header("üì± Building iOS...")
  build_app(
    workspace: "ios/Runner.xcworkspace",
    scheme: "Runner",
    configuration: "Release",
    export_method: "app-store",
    output_directory: "build/ios/ipa",
    output_name: "jinnie.ipa",
    destination: "generic/platform=iOS"
  )

  # Upload to App Store Connect with metadata and submit for review
  UI.header("üì§ Uploading to App Store Connect...")
  upload_to_app_store(
    api_key: {
      key_id: "LW4DRB22XD",
      issuer_id: "aeefe3dd-9558-4a88-bc16-c02f973fe67e",
      key_filepath: File.expand_path("~/.appstoreconnect/private_keys/AuthKey_LW4DRB22XD.p8")
    },
    skip_screenshots: true,
    skip_metadata: false,
    submit_for_review: true,
    automatic_release: true,
    force: true,
    precheck_include_in_app_purchases: false
  )
  UI.success("‚úÖ Upload successful and submitted for review!")

  # Build Android
  UI.header("ü§ñ Building Android...")
  sh("cd .. && flutter build appbundle")

  # Open Android folder
  output_dir = File.expand_path("../build/app/outputs/bundle/release")
  sh("open '#{output_dir}'")

  UI.success("üéâ Complete! iOS uploaded to App Store, Android folder opened for Google Play upload")
  UI.message("üì¶ Android AAB: #{output_dir}/app-release.aab")
end

platform :ios do
  desc "Build IPA and upload to App Store Connect with metadata"
  desc "Options:"
  desc "  bump_type: 'major', 'minor', 'patch' to bump version number (optional, defaults to 'minor')"
  desc "Examples:"
  desc "  fastlane release                    # Bump minor version (default: 1.9.0 -> 1.10.0)"
  desc "  fastlane release bump_type:patch    # Bump patch version (1.9.0 -> 1.9.1)"
  desc "  fastlane release bump_type:minor    # Bump minor version (1.9.0 -> 1.10.0)"
  desc "  fastlane release bump_type:major    # Bump major version (1.9.0 -> 2.0.0)"
  lane :release do |options|
    # Get current version from pubspec.yaml
    pubspec_path = "../pubspec.yaml"
    pubspec = File.read(pubspec_path)
    version_line = pubspec.match(/version:\s*(\d+)\.(\d+)\.(\d+)\+(\d+)/)

    unless version_line
      UI.user_error!("Could not find version in pubspec.yaml")
    end

    major = version_line[1].to_i
    minor = version_line[2].to_i
    patch = version_line[3].to_i
    build_number = version_line[4].to_i

    # Bump version based on bump_type parameter (defaults to 'minor')
    bump_type = options[:bump_type] || 'minor'
    if bump_type
      case bump_type.downcase
      when 'major'
        major += 1
        minor = 0
        patch = 0
        UI.success("Bumping MAJOR version")
      when 'minor'
        minor += 1
        patch = 0
        UI.success("Bumping MINOR version")
      when 'patch'
        patch += 1
        UI.success("Bumping PATCH version")
      else
        UI.user_error!("Invalid bump_type: #{bump_type}. Use 'major', 'minor', or 'patch'")
      end
    end

    # Always increment build number
    new_build_number = build_number + 1

    old_version = "#{major}.#{minor}.#{patch}+#{build_number}"
    new_version = "#{major}.#{minor}.#{patch}+#{new_build_number}"

    UI.message("Current version: #{old_version}")
    UI.message("New version: #{new_version}")

    # Update pubspec.yaml with new version
    new_pubspec = pubspec.sub(
      /version:\s*\d+\.\d+\.\d+\+\d+/,
      "version: #{new_version}"
    )
    File.write(pubspec_path, new_pubspec)

    UI.success("Version bumped to #{new_version}")
    UI.message("Flutter will automatically sync to Xcode from pubspec.yaml")

    # Build the IPA
    build_app(
      workspace: "ios/Runner.xcworkspace",
      scheme: "Runner",
      configuration: "Release",
      export_method: "app-store",
      output_directory: "build/ios/ipa",
      output_name: "jinnie.ipa",
      destination: "generic/platform=iOS"
    )

    # Upload to App Store Connect with metadata
    upload_to_app_store(
      api_key: {
        key_id: "LW4DRB22XD",
        issuer_id: "aeefe3dd-9558-4a88-bc16-c02f973fe67e",
        key_filepath: ENV["APP_STORE_CONNECT_API_KEY_PATH"] || File.expand_path("~/.appstoreconnect/private_keys/AuthKey_LW4DRB22XD.p8")
      },
      skip_screenshots: true,
      skip_metadata: false,
      submit_for_review: false,
      automatic_release: true,
      force: true,
      precheck_include_in_app_purchases: false
    )
  end
end

platform :android do
  desc "Build Android App Bundle and open folder for Google Play upload"
  desc "Options:"
  desc "  bump_type: 'major', 'minor', 'patch' to bump version number (optional, defaults to 'minor')"
  desc "Examples:"
  desc "  fastlane android release                    # Bump minor version and build AAB"
  desc "  fastlane android release bump_type:patch    # Bump patch version and build AAB"
  desc "  fastlane android release bump_type:minor    # Bump minor version and build AAB"
  desc "  fastlane android release bump_type:major    # Bump major version and build AAB"
  lane :release do |options|
    # Get current version from pubspec.yaml
    pubspec_path = "../pubspec.yaml"
    pubspec = File.read(pubspec_path)
    version_line = pubspec.match(/version:\s*(\d+)\.(\d+)\.(\d+)\+(\d+)/)

    unless version_line
      UI.user_error!("Could not find version in pubspec.yaml")
    end

    major = version_line[1].to_i
    minor = version_line[2].to_i
    patch = version_line[3].to_i
    build_number = version_line[4].to_i

    # Bump version based on bump_type parameter (defaults to 'minor')
    bump_type = options[:bump_type] || 'minor'
    if bump_type
      case bump_type.downcase
      when 'major'
        major += 1
        minor = 0
        patch = 0
        UI.success("Bumping MAJOR version")
      when 'minor'
        minor += 1
        patch = 0
        UI.success("Bumping MINOR version")
      when 'patch'
        patch += 1
        UI.success("Bumping PATCH version")
      else
        UI.user_error!("Invalid bump_type: #{bump_type}. Use 'major', 'minor', or 'patch'")
      end
    end

    # Always increment build number
    new_build_number = build_number + 1

    old_version = "#{major}.#{minor}.#{patch}+#{build_number}"
    new_version = "#{major}.#{minor}.#{patch}+#{new_build_number}"

    UI.message("Current version: #{old_version}")
    UI.message("New version: #{new_version}")

    # Update pubspec.yaml with new version
    new_pubspec = pubspec.sub(
      /version:\s*\d+\.\d+\.\d+\+\d+/,
      "version: #{new_version}"
    )
    File.write(pubspec_path, new_pubspec)

    UI.success("Version bumped to #{new_version}")

    # Build the app bundle
    sh("cd .. && flutter build appbundle")

    # Get the output directory
    output_dir = File.expand_path("../build/app/outputs/bundle/release")

    UI.success("‚úÖ App bundle built successfully!")
    UI.message("üìÅ Location: #{output_dir}")
    UI.message("üì¶ File: app-release.aab")

    # Open the folder in Finder (macOS)
    sh("open '#{output_dir}'")

    UI.success("üéâ Folder opened! Ready to upload to Google Play Console")
  end
end
